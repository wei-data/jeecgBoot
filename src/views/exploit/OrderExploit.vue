<template>
  <div class="orderExploit">
    <!-- 搜索块 -->
    <a-card>
      <MySearchVue @isQuery="clickEven" />
    </a-card>
    <!-- 表格区 -->
    <a-form layout="inline" style="margin:10px 0">
      <a-form-item><a-button type="primary" :icon="h(PlusOutlined)" @click="open = true">新增</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">自定义按钮</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">JS增强</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">SQL增强</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">JAVA增强</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">导入数据库表</a-button></a-form-item>
      <a-form-item><a-button type="primary" :icon="h(HighlightOutlined)">代码生成</a-button></a-form-item>
      <a-dropdown>
        <template #overlay>
          <a-menu>
            <a-menu-item key="1" @click='InDels'>
              <DeleteOutlined />
              删除
            </a-menu-item>
          </a-menu>
        </template>
        <a-button>
          批量操作
          <DownOutlined />
        </a-button>
      </a-dropdown>
    </a-form>
    <a-alert v-if="!hasSelected" message="未选中任何数据" type="info" show-icon style="margin: 10px 0;" />
    <a-alert v-else :message="'已选择' + selected.length + '记录(可跨页)'" type="info" show-icon style="margin: 10px 0;">
      <template #action>
        <a-button size="small" type="link" :loading="state.loading" @click="start">清空</a-button>
      </template>
    </a-alert>
    <keep-alive>
      <a-table :row-selection="{ selectedRowKeys: state.selectedRowKeys, onChange: onSelectChange }" :columns="columns"
        :data-source="tableData" :row-key="(record: any) => record.id" :pagination="pagination" bordered
        @change="onunhandlePagetion">
        <template #bodyCell="{ column, text, record }">
          <template v-if="column.dataIndex === 'tableType'">
            <span v-if="text === 1">单表</span>
            <span v-else-if="text === 2">单表(树)</span>
            <span v-else-if="text === 3">主表</span>
            <span v-else>附表</span>
          </template>
          <!-- <template v-if="column.dataIndex === 'tableName'">{{ text }} {{ text.last }}</template> -->
          <template v-if="column.dataIndex === 'isDbSynch'">
            <a-button v-if="text === 'Y'" type="link">已同步</a-button>
            <a-button v-if="text === 'N'" type="link" danger>未同步</a-button>
          </template>
          <template v-if="column.key === 'edit'">
            <a-button type="link" @click="PutEdit(record.id)">编辑</a-button>
            <a-dropdown :arrow="{ pointAtCenter: true }">
              <a class="ant-dropdown-link">
                更多
                <DownOutlined />
              </a>
              <template #overlay>
                <a-menu>
                  <a-menu-item key="1">功能测试</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="2">配置地址</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="3">权限控制</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="4">角色授权</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="5">生成视图</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="6">复制表</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="7">移出</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="8" @click="InDel(record.id)">删除</a-menu-item>
                </a-menu>
              </template>
            </a-dropdown>
          </template>
        </template>
      </a-table>
    </keep-alive>
    <!--模态框部分 -->
    <!-- 添加 -->
    <a-modal v-model:open="open" title="新增" @ok="handleOk" :width="1000">
      <a-divider />
      <a-form layout="inline" :model="formAdd" class="modal">
        <a-form-item label="表名">
          <a-input v-model:value="formAdd.name" placeholder="表名" />
        </a-form-item>
        <a-form-item label="表描述">
          <a-input v-model:value="formAdd.text" placeholder="表描述" />
        </a-form-item>
        <a-form-item label="表单">
          <a-select ref="select" v-model:value="formAdd.types" style="width: 120px">
            <a-select-option value="1">单表</a-select-option>
            <a-select-option value="2">单表(树)</a-select-option>
            <a-select-option value="3">主表</a-select-option>
            <a-select-option value="4">附表</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="表单分类">
          <!-- <a-input v-model:value="formAdd.name" placeholder="测试表单" /> -->
          <a-select ref="select" v-model:value="formAdd.cheshi" style="width: 120px">
            <a-select-option value="官方实列">官方实列</a-select-option>
            <a-select-option value="流程表单">流程表单</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="主键策略">
          <!-- <a-input v-model:value="formAdd.name" placeholder="" /> -->
          <a-select ref="select" v-model:value="formAdd.zhujian" style="width: 120px">
            <a-select-option value="ID_WORKER(分布式自增)">ID_WORKER(分布式自增)</a-select-option>
            <a-select-option value="流程表单">流程表单</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="显示复选框">
          <!-- <a-input v-model:value="formAdd.name" placeholder="是" /> -->
          <a-select ref="select" v-model:value="formAdd.check" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="主体模板">
          <!-- <a-input v-model:value="formAdd.name" disabled placeholder="默认主题" /> -->
          <a-select ref="select" v-model:value="formAdd.commit" style="width: 120px" disabled>
            <a-select-option value="默认主题">默认主题</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="表单风格">
          <!-- <a-input v-model:value="formAdd.name" placeholder="" /> -->
          <a-select ref="select" v-model:value="formAdd.styles" style="width: 120px">
            <a-select-option value="一列">一列</a-select-option>
            <a-select-option value="两列">两列</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="滚动条">
          <!-- <a-input v-model:value="formAdd.name" placeholder="有" /> -->
          <a-select ref="select" v-model:value="formAdd.scrolls" style="width: 120px">
            <a-select-option value="有">有</a-select-option>
            <a-select-option value="无">无</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="是否分页">
          <!-- <a-input v-model:value="formAdd.name" placeholder="是" /> -->
          <a-select ref="select" v-model:value="formAdd.IsPages" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="是否树">
          <!-- <a-input v-model:value="formAdd.thee" placeholder="否" /> -->
          <a-select ref="select" v-model:value="formAdd.thee" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
      </a-form>
      <template #footer>
        <div>
          <a-button type="primary" @click="open = false">取消</a-button>
          <a-button type="primary" @click="InAddAll">确定</a-button>
        </div>
      </template>
    </a-modal>
    <!-- 编辑 -->
    <a-modal v-model:open="openEdit" title="编辑" @ok="handleEditOk" :width="1000">
      <a-divider />
      <a-form layout="inline" :model="formAdd" class="modal">
        <a-form-item label="表名">
          <a-input v-model:value="formAdd.name" placeholder="表名" />
        </a-form-item>
        <a-form-item label="表描述">
          <a-input v-model:value="formAdd.text" placeholder="表描述" />
        </a-form-item>
        <a-form-item label="表单">
          <a-select ref="select" v-model:value="formAdd.types" style="width: 120px">
            <a-select-option value="1">单表</a-select-option>
            <a-select-option value="2">单表(树)</a-select-option>
            <a-select-option value="3">主表</a-select-option>
            <a-select-option value="4">附表</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="表单分类">
          <!-- <a-input v-model:value="formAdd.name" placeholder="测试表单" /> -->
          <a-select ref="select" v-model:value="formAdd.cheshi" style="width: 120px">
            <a-select-option value="官方实列">官方实列</a-select-option>
            <a-select-option value="流程表单">流程表单</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="主键策略">
          <!-- <a-input v-model:value="formAdd.name" placeholder="" /> -->
          <a-select ref="select" v-model:value="formAdd.zhujian" style="width: 120px">
            <a-select-option value="ID_WORKER(分布式自增)">ID_WORKER(分布式自增)</a-select-option>
            <a-select-option value="流程表单">流程表单</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="显示复选框">
          <!-- <a-input v-model:value="formAdd.name" placeholder="是" /> -->
          <a-select ref="select" v-model:value="formAdd.check" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="主体模板">
          <!-- <a-input v-model:value="formAdd.name" disabled placeholder="默认主题" /> -->
          <a-select ref="select" v-model:value="formAdd.commit" style="width: 120px" disabled>
            <a-select-option value="默认主题">默认主题</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="表单风格">
          <!-- <a-input v-model:value="formAdd.name" placeholder="" /> -->
          <a-select ref="select" v-model:value="formAdd.styles" style="width: 120px">
            <a-select-option value="一列">一列</a-select-option>
            <a-select-option value="两列">两列</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="滚动条">
          <!-- <a-input v-model:value="formAdd.name" placeholder="有" /> -->
          <a-select ref="select" v-model:value="formAdd.scrolls" style="width: 120px">
            <a-select-option value="有">有</a-select-option>
            <a-select-option value="无">无</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="是否分页">
          <!-- <a-input v-model:value="formAdd.name" placeholder="是" /> -->
          <a-select ref="select" v-model:value="formAdd.IsPages" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="是否树">
          <!-- <a-input v-model:value="formAdd.thee" placeholder="否" /> -->
          <a-select ref="select" v-model:value="formAdd.thee" style="width: 120px">
            <a-select-option value="是">是</a-select-option>
            <a-select-option value="否">否</a-select-option>
          </a-select>
        </a-form-item>
      </a-form>
    </a-modal>
  </div>
</template>

<script lang="ts" setup>
import MySearchVue from './OrderExploitCommit/ExploitSearch.vue'

import { computed, reactive, ref, h } from 'vue';
import { message } from 'ant-design-vue';
import { getData, dels, del, add, EditData } from '../../api/orderExploit';
import { PlusOutlined, HighlightOutlined, DownOutlined, DeleteOutlined } from '@ant-design/icons-vue'

// 模态框控制器
// 新增
const open = ref<boolean>(false);
//修改
const openEdit = ref<boolean>(false)
// 模态框数据
//修改数据
const put_id = ref('')

const formAdd: any = reactive({
  name: '',
  text: '',
  types: '1',
  cheshi: '官方实列',
  zhujian: 'ID_WORKER(分布式自增)',
  check: '是',
  commit: '默认主题',
  styles: '一列',
  scrolls: '有',
  IsPages: '是',
  thee: '否'
})
// const formState: any = reactive({
//   name: '',
//   type: '',
//   describe: ''
// });

const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0
})
const columns = [
  {
    title: '表类型',
    dataIndex: 'tableType',
    sorter: {
      compare: (a, b) => a.tableType - b.tableType,
      multiple: 1,
    },
    width: '20%',
  },
  {
    title: '表名',
    dataIndex: 'tableName',
    key: 'tableName',
    sorter: true,
    width: '20%',
  },
  {
    title: '表描述',
    dataIndex: 'tableTxt',
    key: 'tableTxt'
  },
  {
    title: '版本',
    dataIndex: 'tableVersion',
    key: 'tableVersion'
  },
  {
    title: '同步状态',
    dataIndex: 'isDbSynch',
    key: 'isDbSynch',
    sorter: {
      compare: (a, b) => a.isDbSynch - b.isDbSynch,
      multiple: 3,
    },
  },
  {
    title: '创建时间',
    dataIndex: 'createTime',
    key: 'createTime',
    sorter: {
      compare: (a, b) => a.createTime - b.createTime,
      multiple: 4,
    },
  },
  {
    title: '操作',
    dataIndex: 'edit',
    key: 'edit',
    width: "20%",
  },
];

// 数据
const tableData = ref([])
// 选中数据
const selected: any = ref([])

const handleOk = (e: MouseEvent) => {
  open.value = false;
};
// 查询
const clickEven = (val: any) => {
  console.log(val);
  tableData.value = val.records
  // getOfData()
}
const state = reactive<{
  selectedRowKeys: (string | number)[];
  loading: boolean;
}>({
  selectedRowKeys: [], // Check here to configure the default column
  loading: false,
});
const hasSelected = computed(() => state.selectedRowKeys.length > 0);

const start = () => {
  state.loading = true;
  // ajax request after empty completing
  setTimeout(() => {
    state.loading = false;
    state.selectedRowKeys = [];
  }, 1000);
};
const onSelectChange = (selectedRowKeys: (string | number)[]) => {
  console.log('selectedRowKeys changed: ', selectedRowKeys);
  state.selectedRowKeys = selectedRowKeys;
  selected.value = selectedRowKeys
};
const onunhandlePagetion = (value) => {
  console.log(value.current)
  pagination.current = value.current
  getOfData()
}

//修改
const PutEdit = (id: string) => {
  console.log(id)
  put_id.value = id
}

const getOfData = async () => {
  const { result } = await getData({
    column: '',
    order: '',
    pageNo: pagination.current,
    pageSize: pagination.pageSize,
    copyType: 0,
    _t: 1691927167750
  })
  console.log(result);
  tableData.value = result.records
  pagination.total = result.total
  pagination.current = result.current
}
getOfData()

// 批量删除
const InDels = async () => {
  let all = []
  selected.value.forEach(item => {
    all.push(item.id)
    console.log(item)
  })
  const data = await dels(all)
  if (data.code === 200) {
    message.success(data.message)
    getOfData()
  } else {
    message.error(data.message)
  }
}
// 删除
const InDel = async (id: string) => {
  const data = await del(id)
  if (data.code === 200) {
    message.success(data.message)
    getOfData()
  } else {
    message.error(data.message)
  }
  console.log(data)
}
// 新增区
const InAddAll = async () => {
  const data = await add({
    head: {
      desFormCode: "",
      extConfigJson: "{\"reportPrintShow\":0,\"reportPrintUrl\":\"\",\"joinQuery\":0,\"modelFullscreen\":0,\"modalMinWidth\":\"\",\"commentStatus\":0}",
      formCategory: "temp",
      formTemplate: "1",
      idType: "UUID",
      isCheckbox: "Y",
      isDesForm: "N",
      isPage: "Y",
      isTree: "N",
      scroll: 1,
      tableName: "12312ewr",
      tableTxt: "qwrrewq",
      tableType: 1,
      themeTemplate: "normal"
    },
    indexs: []
  })
  if (data.code === 200) {
    message.success(data.message)
    getOfData()
  } else {
    message.error(data.message)
  }
}

//修改数据
const handleEditOk = async () => {
  const data = EditData({})
  console.log(data)
}
</script>

<style lang='scss' scoped >
.modal {
  .ant-form-item {
    margin: 20px 10px;
  }
}

.ant-dropdown-link {
  color: blue;
}
</style>
