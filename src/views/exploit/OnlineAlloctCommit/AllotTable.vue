<template>
  <div class="allotTable">
    <a-button type="primary" :icon="h(PlusOutlined)" style='margin:10px 10px 10px 0'
      @click="visibility = true">录入</a-button>
    <a-dropdown v-if="hasSelected">
      <template #overlay>
        <a-menu>
          <a-menu-item key="1" @click.prevent="dels">
            <DeleteOutlined />
            删除
          </a-menu-item>
        </a-menu>
      </template>
      <a-button>
        批量操作
        <DownOutlined />
      </a-button>
    </a-dropdown>
    <a-alert v-if="!hasSelected" message="未选中任何数据" type="info" show-icon style="margin: 10px 0;" />
    <a-alert v-else :message="'已选择' + selected.length + '记录(可跨页)'" type="info" show-icon style="margin: 10px 0;">
      <template #action>
        <a-button size="small" type="link" :loading="state.loading" @click="start">清空</a-button>
      </template>
    </a-alert>
    <!-- 表格 -->
    <keep-alive>
      <a-table :row-selection="{ selectedRowKeys: state.selectedRowKeys, onChange: onSelectChange }" :columns="columns"
        :data-source="tableData" :row-key="(record: any) => record.id" :pagination="pagination" bordered
        @change="onunhandlePagetion">
        <template #bodyCell="{ column, text, record }">
          <template v-if="column.dataIndex === 'tableType'">
            <span v-if="text === 1">单表</span>
            <span v-else-if="text === 2">单表(树)</span>
            <span v-else-if="text === 3">主表</span>
            <span v-else>附表</span>
          </template>
          <template v-if="column.dataIndex === 'isDbSynch'">
            <a-button v-if="text === 'Y'" type="link">已同步</a-button>
            <a-button v-if="text === 'N'" type="link" danger>未同步</a-button>
          </template>
          <template v-if="column.key === 'edit'">
            <a-button type="link" @click="PutEdit(record.id)">编辑</a-button>
            <a-dropdown :arrow="{ pointAtCenter: true }">
              <a class="ant-dropdown-link">
                更多
                <DownOutlined />
              </a>
              <template #overlay>
                <a-menu>
                  <a-menu-item key="1">功能测试</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="2">配置地址</a-menu-item>
                  <a-menu-divider />
                  <a-menu-item key="3" @click='del(record.id)'>删除</a-menu-item>
                </a-menu>
              </template>
            </a-dropdown>
          </template>
        </template>
      </a-table>
    </keep-alive>
    <a-modal v-model:open="visibility" width="1000px" title="新增">
      <a-form :model="formState">
        <a-form-item label="报表编码">
          <a-input v-model:value.trim='formState.code' />
        </a-form-item>
        <a-form-item label="报表名字">
          <a-input v-model:value.trim='formState.name' />
        </a-form-item>
        <a-form-item label="动态数据源">
          <a-select v-model:value="formState.state">
            <a-select-option value="school">school</a-select-option>
            <a-select-option value="chenzhe">chenzhe</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="sql">
          <a-textarea v-model:value.trim='formState.sql' :rows="4" />
        </a-form-item>
      </a-form>
      <template #footer>
        <div>
          <a-button type="white" @click="visibility = false">取消</a-button>
          <a-button type="primary" @click="handleOk">确定</a-button>
        </div>
      </template>
    </a-modal>
  </div>
</template>

<script setup lang='ts'>
import { allocationList, allocationAdd, allocationDels, allocationDel } from '../../../api/allocation'
import { DownOutlined, PlusOutlined } from '@ant-design/icons-vue'
import { reactive, ref, computed, h, defineExpose } from 'vue'
import { message } from 'ant-design-vue';
const visibility = ref(false)
const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0
})
const columns = [
  {
    title: '报表名字',
    dataIndex: 'name',
    width: '15%',
  },
  {
    title: '报表编码',
    dataIndex: 'code',
    key: 'code',
    width: '20%',
  },
  {
    title: '报表SQL',
    dataIndex: 'cgrSql',
    key: 'cgrSql',
    width: '15%'
  },
  {
    title: '数据源',
    dataIndex: 'dbSource',
    key: 'dbSource',
    width: '15%'
  },
  {
    title: '创建时间',
    dataIndex: 'createTime',
    key: 'createTime',
    width: '20%',
  },
  {
    title: '操作',
    dataIndex: 'edit',
    key: 'edit',
    width: "20%",
  },
];
const formState = reactive({
  name: '',
  code: '',
  state: '',
  sql: ''
})

// 数据
const tableData = ref([])
// 选中数据
const selected: any = ref([])

const state = reactive<{
  selectedRowKeys: (string | number)[];
  loading: boolean;
}>({
  selectedRowKeys: [], // Check here to configure the default column
  loading: false,
});
const hasSelected = computed(() => state.selectedRowKeys.length > 0);
const start = () => {
  state.loading = true;
  // ajax request after empty completing
  setTimeout(() => {
    state.loading = false;
    state.selectedRowKeys = [];
  }, 1000);
};
const onSelectChange = (selectedRowKeys: (string | number)[]) => {
  console.log('selectedRowKeys changed: ', selectedRowKeys);
  state.selectedRowKeys = selectedRowKeys;
  selected.value = selectedRowKeys
};
const onunhandlePagetion = (value) => {
  console.log(value.current)
  pagination.current = value.current
}
const PutEdit = (id: string) => {
  console.log(id)
}

const getAllocationList = async () => {
  const { result } = await allocationList({
    column: '',
    order: '',
    pageNo: 1,
    pageSize: 10,
    _t: 1692083638971
  })
  console.log(result)
  tableData.value = result.records
  pagination.total = result.total
  pagination.current = result.current
}
getAllocationList()

// 新增区
const handleOk = async (e: MouseEvent) => {
  console.log(e);
  const data = await allocationAdd({
    head: {
      cgrSql: formState.sql,
      code: formState.code,
      dbSource: formState.state,
      name: formState.name
    },
    items: [],
    params: []
  })
  console.log(data)
  message.info(data.message)
  visibility.value = false;
};

// 批量删除
const dels = async () => {
let arr = []
  selected.value.forEach(item => {
    arr.push(item)
  });
  const data = await allocationDels(arr)
  if (data.code === 200) {
    message.success(data.message)
    getAllocationList()
  }else{
    message.error(data.message)
  }
}
// 删除
const del = async (val: string) => {
  const data = await allocationDel(val)
  if (data.code === 200) {
    message.success(data.message)
    getAllocationList()
  }
}
// 子组件 抛出方法
defineExpose({ tableData });
</script>

<style lang='less' scoped ></style>
